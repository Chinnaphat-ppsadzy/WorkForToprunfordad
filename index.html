<!DOCTYPE html>
<html>
<head>
    <title>Workshop #6</title>
    <style>
        body {text-align: center; padding: 10px;}
        .container { max-width: 500px; margin: auto; border: solid 1px #000; padding: 10px;}
        input, button { margin: 10px; padding: 5px;}
        ul { list-style: none; padding: 0; font-size: 0.8rem;}
        li { margin: 10px 0;}
        .page{ display:none; }
    </style>
</head>

<body>

<div class="container">

<!-- LOGIN -->
<div id="loginPage" class="page">
    <h3>Login</h3>
    <input id="username" placeholder="username">
    <input id="password" type="password" placeholder="password">
    <br>
    <button onclick="login()">Login</button>
</div>

<!-- USER -->
<div id="userPage" class="page">
    <h3>User Upload</h3>
    <input type="file" id="fileInput">
    <button onclick="uploadFile()">Upload</button>
    <p id="uploadStatus"></p>

    <h3>Files on Server</h3>
    <ul id="fileList"></ul>

    <button onclick="logout()">Logout</button>
</div>

<!-- ADMIN -->
<div id="adminPage" class="page">
    <h3>Admin Panel</h3>

    <h3>Files on Server</h3>
    <ul id="adminList"></ul>

    <button onclick="logout()">Logout</button>
</div>

</div>

<script>

const serverUrl = "http://localhost:5000";

show("loginPage");

function show(id){
    document.querySelectorAll(".page").forEach(p=>p.style.display="none");
    document.getElementById(id).style.display="block";
}

// LOGIN
function login(){
    fetch(`${serverUrl}/login`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
            username: username.value,
            password: password.value
        })
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.role === "admin"){
            show("adminPage");
            loadAdminFiles();
        }else{
            show("userPage");
            loadUserFiles();
        }
    })
}

// LOGOUT
function logout(){
    show("loginPage");
}

// UPLOAD
function uploadFile(){
    const fileInput = document.getElementById('fileInput').files[0];
    if (!fileInput) return alert('Please select a file');

    const formData = new FormData();
    formData.append('file', fileInput);

    fetch(`${serverUrl}/upload`, { method: 'POST', body: formData })
        .then(()=> {
            uploadStatus.textContent = "Upload success";
            loadUserFiles();
        });
}

// USER FILE LIST
function loadUserFiles(){
    fetch(`${serverUrl}/files`)
        .then(res=>res.json())
        .then(files=>{
            fileList.innerHTML="";
            files.forEach(file=>{
                fileList.innerHTML += `
                    <li>
                        <a href="${serverUrl}/download/${file}">${file}</a>
                    </li>
                `;
            });
        });
}

// ADMIN FILE LIST
function loadAdminFiles(){
    fetch(`${serverUrl}/files`)
        .then(res=>res.json())
        .then(files=>{
            adminList.innerHTML="";
            files.forEach(file=>{
                adminList.innerHTML += `
                    <li>
                        <a href="${serverUrl}/download/${file}">${file}</a>
                        <button onclick="deleteFile('${file}')">delete</button>
                    </li>
                `;
            });
        });
}

// DELETE FILE
function deleteFile(name){
    if(confirm("delete file?")){
        fetch(`${serverUrl}/delete/${name}`,{method:"DELETE"})
        .then(()=>loadAdminFiles());
    }
}

</script>

</body>
</html>
